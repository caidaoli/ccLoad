# Claude Proxy (ccLoad)

一个 Go 后端服务与前端静态页面（前后端分离，前端通过 JSON API 获取数据）。

## 功能概述

- `POST /v1/messages`：透明转发到上游 Claude `/v1/messages`（仅自动替换 `x-api-key`，请求体保持原样；2xx 响应流式转发）。
- 根据请求体中的 `model` 字段选择渠道：
  - 先按 `priority` 从高到低排序；
  - 同优先级执行轮询（当前内存实现按自然顺序近似；可扩展持久化轮询指针）；
  - 调用上游若非 2xx，则对该渠道应用指数退避冷却（起始1秒、每次错误翻倍、最大30分钟）并尝试下一个渠道；若所有候选都失败或不可用返回 503；
  - 处于冷却期的渠道会被跳过（若全部处于冷却则返回 503）。
- 存储：必须使用 SQLite（默认 `data/ccload.db`），保存渠道、冷却状态、请求日志（成功/失败）与轮询指针。
- 管理与观测：
  - `GET /admin/channels`、`POST/PUT/DELETE /admin/channels/{id}`：管理渠道。
  - `GET /admin/metrics?hours=24&bucket_min=5`：24 小时请求趋势（按桶聚合，默认 5 分钟）。
  - `GET /admin/errors?hours=24&limit=200&offset=0`：错误日志。
- 前端（静态页，前后端分离）：
  - `/web/trend.html`：24 小时请求趋势（成功/错误折线）。
  - `/web/errors.html`：错误日志表格。
  - `/web/channels.html`：渠道管理（增删改启停）。

## 启动

```bash
go run .
# 或者设置端口：
PORT=8080 go run .
```

启动后访问：

- 管理首页：`http://localhost:8080/web/`。
- 代理入口：`POST http://localhost:8080/v1/messages`（请求体需包含 `model` 字段，其他内容按 Anthropic API 保持原样）。

注意：服务仅设置/覆盖上游 `x-api-key`，其余请求头（例如 `anthropic-version`）将按客户端传入透传；请确保客户端设置与上游要求一致。

## 渠道管理

请通过前端页面 `/web/channels.html` 或调用接口 `/admin/channels*` 进行增删改查。渠道被持久化到 SQLite 数据库中。

## SQLite 说明

默认使用 SQLite 存储（纯 Go 驱动 `modernc.org/sqlite`）。若 SQLite 初始化失败，程序会直接退出并打印错误日志。

## 设计要点与取舍

- 透明转发：仅覆盖 `x-api-key`，其余头与请求体按原样传递。
- 失败切换与冷却：失败（非 2xx 或网络错误）即切换到下一个候选，并对失败渠道执行指数退避（1s→2s→4s…，上限30m）；后续选择会跳过冷却中的渠道；若全部候选冷却/无可用则返回 503。
- 趋势与错误：所有请求结果记录到日志，趋势接口按时间桶聚合（成功/错误分别计数）。
  1.通过/v1/messages代理claude的请求
  2.要透明转发，除了自动修改api key外，其他客户端的请求内容不要做任何修改。
  3.要根据请求的model查找支持model的渠道,如果有多个渠道，需要根据优先级排序，优先级高的优先使用；同优先级轮询。如果调用上游失败（返回错误码非200）则自动使用下一个渠道，并按指数退避冷却（1s→2s→4s…，最大30m）；如果冷却时间未到，则返回错误码503
  4.可以使用sqlite数据库存储渠道信息和冷却状态，以及错误信息记录，以便于调试和监控
  5.需要一个html页面显示24小时的请求趋势（正确和错误显示不同的折线）
  6.需要一个html页面显示错误信息记录
  7.需要一个html页面能管理渠道
  8.html要前后端分离
  9.后端项目需要使用go语言实现
