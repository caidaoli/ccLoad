<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>请求趋势 - Claude Proxy</title>
  <link rel="stylesheet" href="/web/styles.css">
  <link rel="preconnect" href="https://fonts.loli.net">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.loli.net/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- 引入 ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- 主内容区域 -->
    <main class="main-content">
      <div class="content-area">
        <!-- 页面标题 -->
        <header class="mb-8">
          <div class="glass-card animate-slide-up" style="padding: var(--space-6);">
            <div class="flex justify-between items-center">
              <div>
                <h1 class="page-title mb-2">
                  请求趋势
                </h1>
                <p class="page-subtitle">
                  24小时内请求成功率和错误率的实时趋势分析
                </p>
              </div>
              <div>
                <button class="btn btn-primary" onclick="loadData()">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  刷新数据
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- 趋势摘要卡片 -->
        <section class="mb-8">
          <div class="grid grid-cols-4 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="metric-card">
              <div class="metric-number" id="total-requests" style="color: var(--primary-500);">--</div>
              <div class="metric-label">总请求</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="peak-success" style="color: var(--success-500);">--</div>
              <div class="metric-label">峰值成功</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="peak-error" style="color: var(--error-500);">--</div>
              <div class="metric-label">峰值错误</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="avg-success-rate">--.-%</div>
              <div class="metric-label">平均成功率</div>
            </div>
          </div>
        </section>

        <!-- 趋势图表 -->
        <section class="mb-8">
          <div class="glass-card animate-slide-up" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-semibold">
                <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 21l4-4 4 4"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                </svg>
                24小时趋势图表
              </h3>
              
              <!-- 控件与图例 -->
              <div class="flex items-center" style="gap:12px; flex-wrap: wrap;">
                <div class="toggle-group" id="range-group">
                  <div class="toggle-btn" data-range="1">1小时</div>
                  <div class="toggle-btn" data-range="6">6小时</div>
                  <div class="toggle-btn active" data-range="24">24小时</div>
                  <div class="toggle-btn" data-range="168">7天</div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="loadData()">刷新</button>
              </div>
            </div>

            <!-- 图表容器 -->
            <div class="chart-container">
              <div class="chart-loading" id="chart-loading">
                <div class="loading-spinner"></div>
                <div>正在加载趋势数据...</div>
              </div>
              <div class="chart-error" id="chart-error" style="display: none;">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.18 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <div class="error-title">加载失败</div>
                <div class="error-message">请检查网络连接或重试</div>
              </div>
              <!-- ECharts 容器 -->
              <div id="chart" style="width: 100%; height: 100%; display: none;"></div>
            </div>

            <!-- 图表时间范围提示 -->
            <div class="chart-info">
              <div class="info-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="bucket-interval">数据更新间隔：--</span>
              </div>
              <div class="info-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span id="data-timerange">24小时数据展示</span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- 样式 -->
  <style>
    .chart-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid var(--neutral-200);
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .chart-loading,
    .chart-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--neutral-700);
      text-align: center;
    }

    .chart-error {
      color: var(--neutral-600);
    }

    .error-title {
      color: var(--error-400);
      font-weight: var(--font-medium);
      margin: var(--space-2) 0 var(--space-1) 0;
    }

    .error-message {
      font-size: var(--text-sm);
    }

    .chart-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--neutral-200);
      font-size: var(--text-sm);
      color: var(--neutral-700);
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .chart-container {
        height: 400px;
      }
      
      .chart-info {
        flex-direction: column;
        gap: var(--space-2);
        align-items: flex-start;
      }
      
      .grid-cols-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .chart-container {
        height: 320px;
      }
    }
  </style>

  <script>
    // 全局变量 
    window.trendData = null;
    window.currentHours = 24;
    window.chartInstance = null;

    async function loadData() {
      try {
        showLoading();
        const bucketMin = computeBucketMin(window.currentHours);
        const res = await fetch(`/admin/metrics?hours=${window.currentHours}&bucket_min=${bucketMin}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const response = await res.json();
        window.trendData = response.success ? (response.data || []) : (response || []);
        
        // 添加调试信息显示
        const debugSince = res.headers.get('X-Debug-Since');
        const debugPoints = res.headers.get('X-Debug-Points');
        const debugTotal = res.headers.get('X-Debug-Total');
        
        console.log('趋势数据调试信息:', {
          since: debugSince,
          points: debugPoints,
          total: debugTotal,
          dataLength: trendData.length
        });
        
        updateSummaryCards();
        renderChart();
        
        // 更新分桶提示
        const iv = document.getElementById('bucket-interval');
        if (iv) iv.textContent = `数据更新间隔：${formatInterval(bucketMin)} | 数据点：${trendData.length} | 总请求：${debugTotal || '未知'}`;
        
      } catch (error) {
        console.error('加载趋势数据失败:', error);
        try { if (window.showError) window.showError('无法加载趋势数据'); } catch(_){}
        showError();
      }
    }

    function computeBucketMin(hours) {
      if (hours <= 1) return 1; // 1分钟
      if (hours <= 6) return 2; // 2分钟
      if (hours <= 24) return 5; // 5分钟
      if (hours <= 72) return 15; // 15分钟
      return 60; // 1小时
    }

    function showLoading() {
      document.getElementById('chart-loading').style.display = 'flex';
      document.getElementById('chart-error').style.display = 'none';
      document.getElementById('chart').style.display = 'none';
      
      // 重置摘要卡片
      ['total-requests', 'peak-success', 'peak-error', 'avg-success-rate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '--';
      });
    }

    function showError() {
      document.getElementById('chart-loading').style.display = 'none';
      document.getElementById('chart-error').style.display = 'flex';
      document.getElementById('chart').style.display = 'none';
    }

    function updateSummaryCards() {
      if (!window.trendData || !window.trendData.length) return;

      let totalRequests = 0;
      let totalSuccess = 0;
      let peakSuccess = 0;
      let peakError = 0;

      window.trendData.forEach(point => {
        const success = point.success || 0;
        const error = point.error || 0;
        totalRequests += success + error;
        totalSuccess += success;
        peakSuccess = Math.max(peakSuccess, success);
        peakError = Math.max(peakError, error);
      });

      const avgSuccessRate = totalRequests > 0 ? ((totalSuccess / totalRequests) * 100) : 0;

      // 更新摘要卡片
      document.getElementById('total-requests').textContent = formatNumber(totalRequests);
      document.getElementById('peak-success').textContent = formatNumber(peakSuccess);
      document.getElementById('peak-error').textContent = formatNumber(peakError);
      document.getElementById('avg-success-rate').textContent = avgSuccessRate.toFixed(1) + '%';
    }

    function renderChart() {
      if (!window.trendData || !window.trendData.length) {
        showError();
        return;
      }

      // 显示图表容器
      document.getElementById('chart-loading').style.display = 'none';
      document.getElementById('chart-error').style.display = 'none';
      document.getElementById('chart').style.display = 'block';

      // 初始化或获取 ECharts 实例
      const chartDom = document.getElementById('chart');
      if (!window.chartInstance) {
        window.chartInstance = echarts.init(chartDom, null, {
          renderer: 'canvas'
        });
      }

      // 准备数据
      const timestamps = window.trendData.map(point => {
        const date = new Date(point.ts || point.Ts);
        if (window.currentHours > 24) {
          return `${date.getMonth()+1}/${date.getDate()} ${pad(date.getHours())}:00`;
        } else {
          return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
      });

      const successData = window.trendData.map(point => point.success || 0);
      const errorData = window.trendData.map(point => point.error || 0);

      // ECharts 配置
      const option = {
        backgroundColor: 'transparent',
        title: {
          show: false
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.85)',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          textStyle: {
            color: '#fff',
            fontSize: 12
          },
          axisPointer: {
            type: 'cross',
            crossStyle: {
              color: '#999',
              width: 1,
              type: 'dashed'
            }
          },
          formatter: function(params) {
            let html = `<div style="font-weight: 600; margin-bottom: 8px;">${params[0].axisValue}</div>`;
            params.forEach(param => {
              const color = param.seriesName === '成功请求' ? '#10b981' : '#ef4444';
              html += `
                <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
                  <span style="display: inline-block; width: 10px; height: 10px; background: ${color}; border-radius: 50%;"></span>
                  <span>${param.seriesName}: ${param.value}</span>
                </div>
              `;
            });
            return html;
          }
        },
        legend: {
          data: ['成功请求', '失败请求'],
          top: 10,
          right: 20,
          textStyle: {
            color: '#666',
            fontSize: 12
          },
          itemWidth: 20,
          itemHeight: 10,
          itemGap: 20
        },
        grid: {
          left: '3%',
          right: '3%',
          bottom: '12%',
          top: '15%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: timestamps,
          axisLine: {
            lineStyle: {
              color: '#e5e7eb'
            }
          },
          axisLabel: {
            color: '#6b7280',
            fontSize: 11,
            rotate: window.currentHours > 24 ? 45 : 0,
            interval: Math.floor(timestamps.length / 10) // 动态间隔
          },
          splitLine: {
            show: true,
            lineStyle: {
              color: '#f3f4f6',
              type: 'dashed'
            }
          }
        },
        yAxis: {
          type: 'value',
          axisLine: {
            lineStyle: {
              color: '#e5e7eb'
            }
          },
          axisLabel: {
            color: '#6b7280',
            fontSize: 11,
            formatter: function(value) {
              if (value >= 1000000) return (value / 1000000) + 'M';
              if (value >= 1000) return (value / 1000) + 'K';
              return value;
            }
          },
          splitLine: {
            lineStyle: {
              color: '#f3f4f6',
              type: 'dashed'
            }
          }
        },
        series: [
          {
            name: '成功请求',
            type: 'line',
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            sampling: 'lttb',
            itemStyle: {
              color: '#10b981'
            },
            lineStyle: {
              width: 3,
              color: '#10b981'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {
                  offset: 0,
                  color: 'rgba(16, 185, 129, 0.3)'
                },
                {
                  offset: 1,
                  color: 'rgba(16, 185, 129, 0.05)'
                }
              ])
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                shadowBlur: 10,
                shadowColor: 'rgba(16, 185, 129, 0.5)'
              }
            },
            data: successData
          },
          {
            name: '失败请求',
            type: 'line',
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            sampling: 'lttb',
            itemStyle: {
              color: '#ef4444'
            },
            lineStyle: {
              width: 3,
              color: '#ef4444'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {
                  offset: 0,
                  color: 'rgba(239, 68, 68, 0.3)'
                },
                {
                  offset: 1,
                  color: 'rgba(239, 68, 68, 0.05)'
                }
              ])
            },
            emphasis: {
              focus: 'series',
              itemStyle: {
                shadowBlur: 10,
                shadowColor: 'rgba(239, 68, 68, 0.5)'
              }
            },
            data: errorData
          }
        ],
        dataZoom: window.currentHours > 24 ? [
          {
            type: 'inside',
            start: 0,
            end: 100,
            minValueSpan: 10
          },
          {
            show: true,
            type: 'slider',
            bottom: '2%',
            start: 0,
            end: 100,
            height: 20,
            borderColor: '#e5e7eb',
            fillerColor: 'rgba(59, 130, 246, 0.15)',
            handleStyle: {
              color: '#3b82f6',
              borderColor: '#3b82f6'
            },
            textStyle: {
              color: '#6b7280',
              fontSize: 10
            }
          }
        ] : [],
        animationDuration: 1000,
        animationEasing: 'cubicInOut'
      };

      // 设置配置并渲染
      window.chartInstance.setOption(option);

      // 响应式调整
      window.addEventListener('resize', () => {
        if (window.chartInstance) {
          window.chartInstance.resize();
        }
      });
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatInterval(min) { 
      return min >= 60 ? (min/60) + '小时' : min + '分钟';
    }

    // 工具函数
    function pad(n) { 
      return (n < 10 ? '0' : '') + n;
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.initTopbar) initTopbar('trend');
      restoreState();
      applyRangeUI();
      bindToggles();
      loadData();
      
      // 定期刷新数据（每5分钟）
      setInterval(loadData, 5 * 60 * 1000);
    });

    function bindToggles() {
      const rangeGroup = document.getElementById('range-group');
      rangeGroup.addEventListener('click', (e) => {
        const t = e.target.closest('.toggle-btn');
        if (!t) return;
        rangeGroup.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        t.classList.add('active');
        const hours = parseInt(t.getAttribute('data-range') || '24', 10);
        window.currentHours = hours;
        const label = document.getElementById('data-timerange');
        if (label) label.textContent = hours === 168 ? '7天数据展示' : `${hours}小时数据展示`;
        persistState();
        loadData();
      });
    }

    function persistState() {
      try {
        localStorage.setItem('trend.rangeHours', String(window.currentHours));
      } catch (_) {}
    }

    function restoreState() {
      try {
        const h = parseInt(localStorage.getItem('trend.rangeHours') || '24', 10);
        if ([1, 6, 24, 168].includes(h)) window.currentHours = h;
        const label = document.getElementById('data-timerange');
        if (label) label.textContent = window.currentHours === 168 ? '7天数据展示' : `${window.currentHours}小时数据展示`;
      } catch (_) {}
    }

    function applyRangeUI() {
      const rangeGroup = document.getElementById('range-group');
      if (!rangeGroup) return;
      rangeGroup.querySelectorAll('.toggle-btn').forEach(btn => {
        const h = parseInt(btn.getAttribute('data-range') || '24', 10);
        btn.classList.toggle('active', h === window.currentHours);
      });
    }

    // 注销功能
    function logout() {
      if (confirm('确定要注销吗？')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/web/login.html';
          })
          .catch(() => {
            window.location.href = '/web/login.html';
          });
      }
    }
  </script>
  <script src="/web/ui.js"></script>
</body>
</html>