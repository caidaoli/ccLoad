<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>请求趋势 - Claude Code & Codex Proxy</title>
  <link rel="stylesheet" href="/web/styles.css">
  <link rel="preconnect" href="https://fonts.loli.net">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.loli.net/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- 引入 ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- 主内容区域 -->
    <main class="main-content">
      <div class="content-area">
        <!-- 页面标题 -->
        <header class="mb-2">
        </header>

        <!-- 趋势摘要卡片 -->
        <section class="mb-4">
          <div class="grid grid-cols-4 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="metric-card">
              <div class="metric-number" id="total-requests" style="color: var(--primary-500);">--</div>
              <div class="metric-label">总请求</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="peak-success" style="color: var(--success-500);">--</div>
              <div class="metric-label">峰值成功</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="peak-error" style="color: var(--error-500);">--</div>
              <div class="metric-label">峰值错误</div>
            </div>
            <div class="metric-card">
              <div class="metric-number" id="avg-success-rate">--.-%</div>
              <div class="metric-label">平均成功率</div>
            </div>
          </div>
        </section>

        <!-- 趋势图表 -->
        <section class="mb-8">
          <div class="glass-card animate-slide-up" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-semibold">
                <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 21l4-4 4 4"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                </svg>
请求趋势图表
              </h3>
              
              <!-- 控件与图例 -->
              <div class="flex items-center" style="gap:12px; flex-wrap: wrap;">
                <div class="toggle-group" id="range-group">
                  <div class="toggle-btn active" data-range="1">1小时</div>
                  <div class="toggle-btn" data-range="6">6小时</div>
                  <div class="toggle-btn" data-range="24">24小时</div>
                  <div class="toggle-btn" data-range="168">7天</div>
                </div>
                <!-- 渠道筛选器 -->
                <div class="channel-filter-container">
                  <button class="btn btn-secondary btn-sm" onclick="toggleChannelFilter()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                    </svg>
                    渠道筛选
                  </button>
                  <div class="channel-filter-dropdown" id="channel-filter-dropdown" style="display: none;">
                    <div class="filter-header">
                      <span>选择渠道</span>
                      <div class="filter-actions">
                        <button class="filter-action" onclick="selectAllChannels()">全选</button>
                        <button class="filter-action" onclick="clearAllChannels()">清空</button>
                      </div>
                    </div>
                    <div class="filter-content" id="channel-filter-list">
                      <!-- 动态生成渠道列表 -->
                    </div>
                  </div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="loadData()">刷新</button>
              </div>
            </div>

            <!-- 图表容器 -->
            <div class="chart-container">
              <div class="chart-loading" id="chart-loading">
                <div class="loading-spinner"></div>
                <div>正在加载趋势数据...</div>
              </div>
              <div class="chart-error" id="chart-error" style="display: none;">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.18 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <div class="error-title">加载失败</div>
                <div class="error-message">请检查网络连接或重试</div>
              </div>
              <!-- ECharts 容器 -->
              <div id="chart" style="width: 100%; height: 100%; display: none;"></div>
            </div>

            <!-- 图表时间范围提示 -->
            <div class="chart-info">
              <div class="info-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="bucket-interval">数据更新间隔：--</span>
              </div>
              <div class="info-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span id="data-timerange">1小时数据展示</span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>


  <script>
    // 全局变量 
    window.trendData = null;
    window.currentHours = 1;
    window.chartInstance = null;
    window.channels = [];
    window.visibleChannels = new Set(); // 可见渠道集合

    async function loadData() {
      try {
        showLoading();
        const bucketMin = computeBucketMin(window.currentHours);
        
        // 并行加载趋势数据和渠道列表
        const [metricsRes, channelsRes] = await Promise.all([
          fetch(`/admin/metrics?hours=${window.currentHours}&bucket_min=${bucketMin}`),
          fetch('/admin/channels')
        ]);
        
        if (!metricsRes.ok) throw new Error(`HTTP ${metricsRes.status}`);
        if (!channelsRes.ok) throw new Error(`获取渠道列表失败: ${channelsRes.status}`);
        
        const metricsResponse = await metricsRes.json();
        const channelsResponse = await channelsRes.json();
        
        window.trendData = metricsResponse.success ? (metricsResponse.data || []) : (metricsResponse || []);
        window.channels = channelsResponse.success ? (channelsResponse.data || []) : (channelsResponse || []);
        
        // 修复：智能初始化渠道显示状态（处理localStorage过时数据）
        if (window.visibleChannels.size === 0) {
          // 首次访问：完整初始化
          console.log('初始化渠道显示状态（首次访问）...');

          // 从趋势数据中提取所有实际存在的渠道名称
          const channelsInData = new Set();
          window.trendData.forEach(point => {
            if (point.channels) {
              Object.keys(point.channels).forEach(name => {
                const chData = point.channels[name];
                if ((chData.success || 0) + (chData.error || 0) > 0) {
                  channelsInData.add(name);
                }
              });
            }
          });
          console.log('趋势数据中的渠道:', Array.from(channelsInData));

          // 添加启用的已配置渠道
          window.channels.forEach(ch => {
            if (ch.enabled && hasChannelData(ch.name, window.trendData)) {
              window.visibleChannels.add(ch.name);
              console.log(`添加已配置渠道: ${ch.name}`);
            }
          });

          // 添加数据中存在但不在配置列表中的渠道（如"未知渠道"）
          channelsInData.forEach(name => {
            if (!window.channels.find(ch => ch.name === name)) {
              window.visibleChannels.add(name);
              console.log(`添加数据中的未配置渠道: ${name}`);
            }
          });

          console.log('初始化完成，可见渠道:', Array.from(window.visibleChannels));

          // 修复：持久化初始化状态（避免每次刷新都重新初始化）
          persistChannelState();
        } else {
          // 修复：验证并清理localStorage中过时的渠道选择
          console.log('验证现有渠道选择状态...', Array.from(window.visibleChannels));
          const validChannels = new Set();
          let hasInvalidChannels = false;

          // 检查每个已保存渠道是否在当前数据中存在
          window.visibleChannels.forEach(channelName => {
            if (hasChannelData(channelName, window.trendData)) {
              validChannels.add(channelName);
            } else {
              console.log(`清理过时渠道: ${channelName}（数据中不存在）`);
              hasInvalidChannels = true;
            }
          });

          // 如果清理后为空且有数据，重新初始化所有可见渠道
          if (validChannels.size === 0 && window.trendData.length > 0) {
            console.log('所有保存的渠道已失效，重新初始化...');

            // 从趋势数据中提取所有有数据的渠道
            window.trendData.forEach(point => {
              if (point.channels) {
                Object.keys(point.channels).forEach(name => {
                  const chData = point.channels[name];
                  if ((chData.success || 0) + (chData.error || 0) > 0) {
                    validChannels.add(name);
                  }
                });
              }
            });

            // 添加已配置的启用渠道
            window.channels.forEach(ch => {
              if (ch.enabled && hasChannelData(ch.name, window.trendData)) {
                validChannels.add(ch.name);
              }
            });
          }

          // 更新visibleChannels为验证后的集合
          window.visibleChannels = validChannels;

          // 如果有清理或重新初始化，保存新状态
          if (hasInvalidChannels || validChannels.size > 0) {
            persistChannelState();
            console.log('更新后的可见渠道:', Array.from(window.visibleChannels));
          }
        }
        
        // 添加调试信息显示
        const debugSince = metricsRes.headers.get('X-Debug-Since');
        const debugPoints = metricsRes.headers.get('X-Debug-Points');
        const debugTotal = metricsRes.headers.get('X-Debug-Total');
        
        console.log('趋势数据调试信息:', {
          since: debugSince,
          points: debugPoints,
          total: debugTotal,
          dataLength: trendData.length,
          channelsCount: window.channels.length
        });
        
        updateSummaryCards();
        updateChannelFilter();
        renderChart();
        
        // 更新分桶提示
        const iv = document.getElementById('bucket-interval');
        if (iv) iv.textContent = `数据更新间隔：${formatInterval(bucketMin)} | 数据点：${trendData.length} | 总请求：${debugTotal || '未知'}`;
        
      } catch (error) {
        console.error('加载趋势数据失败:', error);
        try { if (window.showError) window.showError('无法加载趋势数据'); } catch(_){}
        showError();
      }
    }

    function computeBucketMin(hours) {
      if (hours <= 1) return 1; // 1分钟
      if (hours <= 6) return 2; // 2分钟
      if (hours <= 24) return 5; // 5分钟
      if (hours <= 72) return 15; // 15分钟
      return 60; // 1小时
    }

    function showLoading() {
      document.getElementById('chart-loading').style.display = 'flex';
      document.getElementById('chart-error').style.display = 'none';
      document.getElementById('chart').style.display = 'none';
      
      // 重置摘要卡片
      ['total-requests', 'peak-success', 'peak-error', 'avg-success-rate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '--';
      });
    }

    function showError() {
      document.getElementById('chart-loading').style.display = 'none';
      document.getElementById('chart-error').style.display = 'flex';
      document.getElementById('chart').style.display = 'none';
    }

    function updateSummaryCards() {
      if (!window.trendData || !window.trendData.length) return;

      let totalRequests = 0;
      let totalSuccess = 0;
      let peakSuccess = 0;
      let peakError = 0;

      window.trendData.forEach(point => {
        const success = point.success || 0;
        const error = point.error || 0;
        totalRequests += success + error;
        totalSuccess += success;
        peakSuccess = Math.max(peakSuccess, success);
        peakError = Math.max(peakError, error);
      });

      const avgSuccessRate = totalRequests > 0 ? ((totalSuccess / totalRequests) * 100) : 0;

      // 更新摘要卡片
      document.getElementById('total-requests').textContent = formatNumber(totalRequests);
      document.getElementById('peak-success').textContent = formatNumber(peakSuccess);
      document.getElementById('peak-error').textContent = formatNumber(peakError);
      document.getElementById('avg-success-rate').textContent = avgSuccessRate.toFixed(1) + '%';
    }

    function renderChart() {
      if (!window.trendData || !window.trendData.length) {
        showError();
        return;
      }

      // 显示图表容器
      document.getElementById('chart-loading').style.display = 'none';
      document.getElementById('chart-error').style.display = 'none';
      document.getElementById('chart').style.display = 'block';

      // 初始化或获取 ECharts 实例
      const chartDom = document.getElementById('chart');
      if (!window.chartInstance) {
        window.chartInstance = echarts.init(chartDom, null, {
          renderer: 'canvas'
        });
      }

      // 准备时间数据
      const timestamps = window.trendData.map(point => {
        const date = new Date(point.ts || point.Ts);
        if (window.currentHours > 24) {
          return `${date.getMonth()+1}/${date.getDate()} ${pad(date.getHours())}:00`;
        } else {
          return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
      });

      // 为每个可见渠道生成颜色
      const channelColors = generateChannelColors(window.visibleChannels);
      
      // 准备series数据
      const series = [];
      
      // 添加总体成功/失败线
      series.push({
        name: '总成功请求',
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 4,
        sampling: 'lttb',
        itemStyle: {
          color: '#10b981'
        },
        lineStyle: {
          width: 2,
          color: '#10b981'
        },
        data: window.trendData.map(point => point.success || 0)
      });
      
      series.push({
        name: '总失败请求',
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 4,
        sampling: 'lttb',
        itemStyle: {
          color: '#ef4444'
        },
        lineStyle: {
          width: 2,
          color: '#ef4444'
        },
        data: window.trendData.map(point => point.error || 0)
      });
      
      // 为每个可见渠道添加成功/失败线 - 添加数据验证
      console.log('开始渲染渠道数据，可见渠道:', Array.from(window.visibleChannels));
      
      Array.from(window.visibleChannels).forEach(channelName => {
        const color = channelColors[channelName];
        
        // 计算渠道数据总和用于验证
        let successTotal = 0;
        let errorTotal = 0;
        const successData = window.trendData.map(point => {
          const channels = point.channels || {};
          const channelData = channels[channelName] || { success: 0, error: 0 };
          const success = channelData.success || 0;
          successTotal += success;
          return success;
        });
        
        const errorData = window.trendData.map(point => {
          const channels = point.channels || {};
          const channelData = channels[channelName] || { success: 0, error: 0 };
          const error = channelData.error || 0;
          errorTotal += error;
          return error;
        });
        
        console.log(`渠道 ${channelName} 数据统计: 成功总数=${successTotal}, 错误总数=${errorTotal}`);
        
        // 只有当渠道有数据时才添加到图表
        if (successTotal > 0 || errorTotal > 0) {
          console.log(`添加有数据的渠道到图表: ${channelName}`);
          
          // 成功线 - 只有成功数据大于0才添加
          if (successTotal > 0) {
            series.push({
              name: `${channelName}(成功)`,
              type: 'line',
              smooth: true,
              symbol: 'none',
              sampling: 'lttb',
              itemStyle: {
                color: color
              },
              lineStyle: {
                width: 1.5,
                color: color,
                type: 'solid'
              },
              data: successData
            });
          }
          
          // 失败线 - 只有失败数据大于0才添加
          if (errorTotal > 0) {
            series.push({
              name: `${channelName}(失败)`,
              type: 'line',
              smooth: true,
              symbol: 'none',
              sampling: 'lttb',
              itemStyle: {
                color: color
              },
              lineStyle: {
                width: 1.5,
                color: color,
                type: 'dashed'
              },
              data: errorData
            });
          }
        } else {
          console.log(`跳过无数据的渠道: ${channelName}`);
        }
      });

      // ECharts 配置
      const option = {
        backgroundColor: 'transparent',
        title: {
          show: false
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.85)',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          textStyle: {
            color: '#fff',
            fontSize: 12
          },
          axisPointer: {
            type: 'cross',
            crossStyle: {
              color: '#999',
              width: 1,
              type: 'dashed'
            }
          },
          formatter: function(params) {
            let html = `<div style="font-weight: 600; margin-bottom: 8px;">${params[0].axisValue}</div>`;
            params.forEach(param => {
              const color = param.color;
              html += `
                <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
                  <span style="display: inline-block; width: 10px; height: 10px; background: ${color}; border-radius: 50%;"></span>
                  <span>${param.seriesName}: ${param.value}</span>
                </div>
              `;
            });
            return html;
          }
        },
        legend: {
          data: series.map(s => s.name),
          top: 10,
          right: 20,
          textStyle: {
            color: '#666',
            fontSize: 11
          },
          itemWidth: 20,
          itemHeight: 8,
          itemGap: 12,
          type: 'scroll',
          pageIconColor: '#666',
          pageIconInactiveColor: '#ccc',
          pageIconSize: 12,
          pageTextStyle: {
            color: '#666',
            fontSize: 10
          }
        },
        grid: {
          left: '3%',
          right: '3%',
          bottom: '12%',
          top: '20%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: timestamps,
          axisLine: {
            lineStyle: {
              color: '#e5e7eb'
            }
          },
          axisLabel: {
            color: '#6b7280',
            fontSize: 11,
            rotate: window.currentHours > 24 ? 45 : 0,
            interval: Math.floor(timestamps.length / 10) // 动态间隔
          },
          splitLine: {
            show: true,
            lineStyle: {
              color: '#f3f4f6',
              type: 'dashed'
            }
          }
        },
        yAxis: {
          type: 'value',
          axisLine: {
            lineStyle: {
              color: '#e5e7eb'
            }
          },
          axisLabel: {
            color: '#6b7280',
            fontSize: 11,
            formatter: function(value) {
              if (value >= 1000000) return (value / 1000000) + 'M';
              if (value >= 1000) return (value / 1000) + 'K';
              return value;
            }
          },
          splitLine: {
            lineStyle: {
              color: '#f3f4f6',
              type: 'dashed'
            }
          }
        },
        series: series,
        dataZoom: window.currentHours > 24 ? [
          {
            type: 'inside',
            start: 0,
            end: 100,
            minValueSpan: 10
          },
          {
            show: true,
            type: 'slider',
            bottom: '2%',
            start: 0,
            end: 100,
            height: 20,
            borderColor: '#e5e7eb',
            fillerColor: 'rgba(59, 130, 246, 0.15)',
            handleStyle: {
              color: '#3b82f6',
              borderColor: '#3b82f6'
            },
            textStyle: {
              color: '#6b7280',
              fontSize: 10
            }
          }
        ] : [],
        animationDuration: 1000,
        animationEasing: 'cubicInOut'
      };

      // 设置配置并渲染
      window.chartInstance.setOption(option, true); // true 表示不合并，全量更新
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatInterval(min) { 
      return min >= 60 ? (min/60) + '小时' : min + '分钟';
    }

    // 工具函数
    function pad(n) {
      return (n < 10 ? '0' : '') + n;
    }
    
    // 检查渠道是否有数据的函数
    function hasChannelData(channelName, trendData) {
      if (!trendData || !trendData.length) {
        console.log(`hasChannelData: 没有趋势数据 for ${channelName}`);
        return false;
      }
      
      let totalSuccess = 0;
      let totalError = 0;
      
      trendData.forEach(point => {
        const channels = point.channels || {};
        const channelData = channels[channelName] || { success: 0, error: 0 };
        totalSuccess += channelData.success || 0;
        totalError += channelData.error || 0;
      });
      
      const hasData = (totalSuccess + totalError) > 0;
      console.log(`hasChannelData: ${channelName} - success=${totalSuccess}, error=${totalError}, hasData=${hasData}`);
      return hasData;
    }
    
    // 生成渠道颜色
    function generateChannelColors(channels) {
      const colors = [
        '#3b82f6', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444',
        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
        '#14b8a6', '#eab308', '#f43f5e', '#8b5cf6', '#22c55e'
      ];
      
      const channelColors = {};
      let colorIndex = 0;
      Array.from(channels).forEach(channelName => {
        channelColors[channelName] = colors[colorIndex % colors.length];
        colorIndex++;
      });
      
      return channelColors;
    }
    
    // 更新渠道筛选器 - 显示所有有数据的渠道（包括未配置的渠道）
    function updateChannelFilter() {
      const filterList = document.getElementById('channel-filter-list');
      if (!filterList) return;
      
      // 收集所有有数据的渠道名称
      const allChannelNames = new Set();
      
      // 添加已配置的启用渠道
      if (window.channels) {
        window.channels.forEach(ch => {
          if (ch.enabled && hasChannelData(ch.name, window.trendData)) {
            allChannelNames.add(ch.name);
          }
        });
      }
      
      // 添加趋势数据中存在但未配置的渠道（如"未知渠道"）
      if (window.trendData) {
        window.trendData.forEach(point => {
          if (point.channels) {
            Object.keys(point.channels).forEach(name => {
              const chData = point.channels[name];
              if ((chData.success || 0) + (chData.error || 0) > 0) {
                allChannelNames.add(name);
              }
            });
          }
        });
      }
      
      console.log('筛选器中的所有渠道:', Array.from(allChannelNames));
      
      // 生成颜色映射
      const channelColors = generateChannelColors(allChannelNames);
      
      filterList.innerHTML = '';
      
      // 渲染渠道列表
      Array.from(allChannelNames).sort().forEach(channelName => {
        const item = document.createElement('div');
        item.className = 'channel-filter-item';
        item.onclick = () => toggleChannel(channelName);
        
        const isVisible = window.visibleChannels.has(channelName);
        
        // 为"未知渠道"添加特殊标识
        const displayName = channelName === '未知渠道' 
          ? `${channelName} ⚠️` 
          : channelName;
        
        item.innerHTML = `
          <div class="channel-checkbox ${isVisible ? 'checked' : ''}"></div>
          <div class="channel-color-indicator" style="background-color: ${channelColors[channelName]}"></div>
          <div class="channel-name">${displayName}</div>
        `;
        
        filterList.appendChild(item);
      });
    }
    
    // 切换渠道显示/隐藏
    function toggleChannel(channelName) {
      if (window.visibleChannels.has(channelName)) {
        window.visibleChannels.delete(channelName);
      } else {
        window.visibleChannels.add(channelName);
      }
      
      updateChannelFilter();
      renderChart();
      persistChannelState();
    }
    
    // 全选渠道 - 选择所有有数据的渠道（包括未配置的渠道）
    function selectAllChannels() {
      // 添加已配置的启用渠道
      if (window.channels) {
        window.channels.forEach(ch => {
          if (ch.enabled && hasChannelData(ch.name, window.trendData)) {
            window.visibleChannels.add(ch.name);
          }
        });
      }
      
      // 添加趋势数据中存在但未配置的渠道
      if (window.trendData) {
        window.trendData.forEach(point => {
          if (point.channels) {
            Object.keys(point.channels).forEach(name => {
              const chData = point.channels[name];
              if ((chData.success || 0) + (chData.error || 0) > 0) {
                window.visibleChannels.add(name);
              }
            });
          }
        });
      }
      
      updateChannelFilter();
      renderChart();
      persistChannelState();
    }
    
    // 清空选择
    function clearAllChannels() {
      window.visibleChannels.clear();
      
      updateChannelFilter();
      renderChart();
      persistChannelState();
    }
    
    // 切换渠道筛选器显示/隐藏
    function toggleChannelFilter() {
      const dropdown = document.getElementById('channel-filter-dropdown');
      if (!dropdown) return;
      
      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        // 点击外部关闭
        setTimeout(() => {
          document.addEventListener('click', closeChannelFilter, true);
        }, 10);
      }
    }
    
    function closeChannelFilter(event) {
      const dropdown = document.getElementById('channel-filter-dropdown');
      const container = document.querySelector('.channel-filter-container');
      
      if (!dropdown || !container) return;
      
      if (!container.contains(event.target)) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeChannelFilter, true);
      }
    }
    
    // 持久化渠道状态
    function persistChannelState() {
      try {
        const visibleArray = Array.from(window.visibleChannels);
        localStorage.setItem('trend.visibleChannels', JSON.stringify(visibleArray));
      } catch (_) {}
    }
    
    // 恢复渠道状态
    function restoreChannelState() {
      try {
        const saved = localStorage.getItem('trend.visibleChannels');
        if (saved) {
          const visibleArray = JSON.parse(saved);
          window.visibleChannels = new Set(visibleArray);
        }
      } catch (_) {}
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.initTopbar) initTopbar('trend');
      restoreState();
      restoreChannelState();
      applyRangeUI();
      bindToggles();
      loadData();

      // 修复：全局注册resize监听器（仅一次，避免内存泄漏）
      window.addEventListener('resize', () => {
        if (window.chartInstance) {
          window.chartInstance.resize();
        }
      });

      // 定期刷新数据（每5分钟）
      setInterval(loadData, 5 * 60 * 1000);
    });

    function bindToggles() {
      const rangeGroup = document.getElementById('range-group');
      rangeGroup.addEventListener('click', (e) => {
        const t = e.target.closest('.toggle-btn');
        if (!t) return;
        rangeGroup.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        t.classList.add('active');
        const hours = parseInt(t.getAttribute('data-range') || '24', 10);
        window.currentHours = hours;
        const label = document.getElementById('data-timerange');
        if (label) label.textContent = hours === 168 ? '7天数据展示' : `${hours}小时数据展示`;
        persistState();
        loadData();
      });
    }

    function persistState() {
      try {
        localStorage.setItem('trend.rangeHours', String(window.currentHours));
      } catch (_) {}
    }

    function restoreState() {
      try {
        const h = parseInt(localStorage.getItem('trend.rangeHours') || '1', 10);
        if ([1, 6, 24, 168].includes(h)) window.currentHours = h;
        const label = document.getElementById('data-timerange');
        if (label) label.textContent = window.currentHours === 168 ? '7天数据展示' : `${window.currentHours}小时数据展示`;
      } catch (_) {}
    }

    function applyRangeUI() {
      const rangeGroup = document.getElementById('range-group');
      if (!rangeGroup) return;
      rangeGroup.querySelectorAll('.toggle-btn').forEach(btn => {
        const h = parseInt(btn.getAttribute('data-range') || '24', 10);
        btn.classList.toggle('active', h === window.currentHours);
      });
    }

    // 注销功能
    function logout() {
      if (confirm('确定要注销吗？')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/web/login.html';
          })
          .catch(() => {
            window.location.href = '/web/login.html';
          });
      }
    }
  </script>
  <script src="/web/ui.js"></script>
</body>
</html>