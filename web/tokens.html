<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APIè®¿é—®ä»¤ç‰Œ - Claude Code & Codex Proxy</title>
  <link rel="stylesheet" href="/web/styles.css">
  <link rel="preconnect" href="https://fonts.loli.net">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.loli.net/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/web/ui.js"></script>
  <style>
    .token-table {
      width: 100%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .token-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .token-table thead {
      background: var(--neutral-100);
    }
    .token-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--neutral-700);
      border-bottom: 1px solid var(--neutral-200);
    }
    .token-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--neutral-100);
      font-size: 14px;
    }
    .token-table tbody tr:hover {
      background: var(--neutral-50);
    }
    .token-table tbody tr:last-child td {
      border-bottom: none;
    }
    .token-display {
      font-family: monospace;
      background: var(--neutral-100);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
      display: inline-block;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active {
      background: var(--success-100);
      color: var(--success-700);
    }
    .status-inactive {
      background: var(--neutral-200);
      color: var(--neutral-700);
    }
    .status-expired {
      background: var(--error-100);
      color: var(--error-700);
    }
    .stats-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      background: var(--neutral-100);
      color: var(--neutral-700);
    }
    .success-rate-high {
      background: var(--success-100);
      color: var(--success-700);
    }
    .success-rate-medium {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    .success-rate-low {
      background: var(--error-100);
      color: var(--error-700);
    }
    .metric-value {
      font-weight: 600;
      color: var(--neutral-900);
    }
    .metric-label {
      font-size: 11px;
      color: var(--neutral-600);
      margin-top: 2px;
    }
    /* å“åº”æ—¶é—´é¢œè‰² */
    .response-fast {
      color: var(--success-700);
      font-weight: 600;
    }
    .response-medium {
      color: var(--warning-700);
      font-weight: 600;
    }
    .response-slow {
      color: var(--error-700);
      font-weight: 600;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.2s;
    }
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      max-width: 600px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideUp 0.3s;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body {
      padding: 24px;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--neutral-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <main class="main-content">
      <div class="content-area">
         <header class="mb-2">
        </header>
        <header class="mb-4">
          <div class="glass-card animate-slide-up" style="padding: var(--space-6);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
              <div>
                <h1 class="page-title mb-2">APIè®¿é—®ä»¤ç‰Œ</h1>
                <p class="page-subtitle" style="margin: 0;">ç®¡ç†ç”¨äº API (/v1/*) è®¿é—®çš„ä»¤ç‰Œ</p>
              </div>
              <button onclick="showCreateModal()" class="btn btn-primary" style="padding: 8px 16px;">
                + åˆ›å»ºä»¤ç‰Œ
              </button>
            </div>
          </div>
        </header>

        <section>
          <!-- ä»¤ç‰Œè¡¨æ ¼ -->
          <div id="tokens-container" class="token-table"></div>

          <!-- ç©ºçŠ¶æ€ -->
          <div id="empty-state" class="glass-card" style="display: none; text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”‘</div>
            <h3 style="color: var(--neutral-900); margin-bottom: 8px; font-weight: 600;">æš‚æ— APIä»¤ç‰Œ</h3>
            <p style="color: var(--neutral-700); margin-bottom: 24px; font-size: 15px;">ç‚¹å‡»"åˆ›å»ºä»¤ç‰Œ"æŒ‰é’®,ç”Ÿæˆç¬¬ä¸€ä¸ªAPIè®¿é—®ä»¤ç‰Œ</p>
            <button onclick="showCreateModal()" class="btn btn-primary">åˆ›å»ºä»¤ç‰Œ</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- åˆ›å»ºä»¤ç‰Œå¯¹è¯æ¡† -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0; font-size: 18px;">åˆ›å»ºAPIä»¤ç‰Œ</h2>
        <button onclick="closeCreateModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-500);">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æè¿° *</label>
          <input type="text" id="tokenDescription" class="form-input" placeholder="è¯·è¾“å…¥ä»¤ç‰Œç”¨é€”æè¿°" required>
        </div>

        <div class="form-group">
          <label class="form-label">è¿‡æœŸæ—¶é—´</label>
          <select id="tokenExpiry" class="form-input">
            <option value="never">æ°¸ä¸è¿‡æœŸ</option>
            <option value="30d">30å¤©åè¿‡æœŸ</option>
            <option value="90d">90å¤©åè¿‡æœŸ</option>
            <option value="180d">180å¤©åè¿‡æœŸ</option>
            <option value="365d">1å¹´åè¿‡æœŸ</option>
            <option value="custom">è‡ªå®šä¹‰...</option>
          </select>
        </div>

        <div id="customExpiryContainer" style="display: none;" class="form-group">
          <label class="form-label">è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´</label>
          <input type="datetime-local" id="customExpiry" class="form-input">
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="tokenActive" checked style="width: 18px; height: 18px;">
            <span>å¯ç”¨ä»¤ç‰Œ</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeCreateModal()" class="btn btn-secondary">å–æ¶ˆ</button>
        <button onclick="createToken()" class="btn btn-primary">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- æ˜¾ç¤ºæ–°ä»¤ç‰Œå¯¹è¯æ¡† -->
  <div id="tokenResultModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0; font-size: 18px;">ä»¤ç‰Œåˆ›å»ºæˆåŠŸ</h2>
        <button onclick="closeTokenResultModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-500);">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="font-weight: 600; color: var(--warning-700); margin-bottom: 8px;">âš ï¸ é‡è¦æç¤º:</div>
          <div style="font-size: 14px; color: var(--warning-800);">
            è¯·ç«‹å³å¤åˆ¶å¹¶ä¿å­˜æ­¤ä»¤ç‰Œã€‚å…³é—­æ­¤çª—å£å,æ‚¨å°†æ— æ³•å†æ¬¡æŸ¥çœ‹å®Œæ•´ä»¤ç‰Œã€‚
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">APIä»¤ç‰Œ(è¯·å¦¥å–„ä¿ç®¡)</label>
          <div style="position: relative;">
            <textarea id="newTokenValue" readonly class="form-input" style="font-family: monospace; font-size: 13px; height: 80px; resize: none;"></textarea>
            <button onclick="copyToken()" class="btn btn-secondary" style="position: absolute; top: 8px; right: 8px; padding: 4px 12px; font-size: 13px;">
              å¤åˆ¶
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeTokenResultModal()" class="btn btn-primary">æˆ‘å·²ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘ä»¤ç‰Œå¯¹è¯æ¡† -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0; font-size: 18px;">ç¼–è¾‘ä»¤ç‰Œ</h2>
        <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-500);">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editTokenId">

        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <input type="text" id="editTokenDescription" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">è¿‡æœŸæ—¶é—´</label>
          <select id="editTokenExpiry" class="form-input">
            <option value="never">æ°¸ä¸è¿‡æœŸ</option>
            <option value="30d">30å¤©åè¿‡æœŸ</option>
            <option value="90d">90å¤©åè¿‡æœŸ</option>
            <option value="180d">180å¤©åè¿‡æœŸ</option>
            <option value="365d">1å¹´åè¿‡æœŸ</option>
            <option value="custom">è‡ªå®šä¹‰...</option>
          </select>
        </div>

        <div id="editCustomExpiryContainer" style="display: none;" class="form-group">
          <label class="form-label">è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´</label>
          <input type="datetime-local" id="editCustomExpiry" class="form-input">
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="editTokenActive" style="width: 18px; height: 18px;">
            <span>å¯ç”¨ä»¤ç‰Œ</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeEditModal()" class="btn btn-secondary">å–æ¶ˆ</button>
        <button onclick="updateToken()" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/admin';
    let allTokens = [];
    let selectedTokenIds = new Set();

    document.addEventListener('DOMContentLoaded', () => {
      loadTokens();
      document.getElementById('tokenExpiry').addEventListener('change', (e) => {
        document.getElementById('customExpiryContainer').style.display =
          e.target.value === 'custom' ? 'block' : 'none';
      });
      document.getElementById('editTokenExpiry').addEventListener('change', (e) => {
        document.getElementById('editCustomExpiryContainer').style.display =
          e.target.value === 'custom' ? 'block' : 'none';
      });
    });

    async function loadTokens() {
      try {
        const response = await fetchWithAuth(`${API_BASE}/auth-tokens`);
        if (!response.ok) throw new Error('åŠ è½½ä»¤ç‰Œå¤±è´¥');
        const data = await response.json();
        allTokens = data.data || [];
        renderTokens();
      } catch (error) {
        console.error('åŠ è½½ä»¤ç‰Œå¤±è´¥:', error);
        showToast('åŠ è½½ä»¤ç‰Œå¤±è´¥: ' + error.message, 'error');
      }
    }

    function renderTokens() {
      const container = document.getElementById('tokens-container');
      const emptyState = document.getElementById('empty-state');

      if (allTokens.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      // æ ¹æ®é€‰ä¸­çŠ¶æ€å†³å®šæ“ä½œåˆ—æ˜¾ç¤ºå†…å®¹
      const hasSelection = selectedTokenIds.size > 0;
      const operationHeader = hasSelection
        ? `<div style="display: flex; align-items: center; gap: 8px;">
             <span style="color: var(--primary-700); font-weight: 600; font-size: 12px;">å·²é€‰æ‹© ${selectedTokenIds.size} é¡¹</span>
             <button onclick="batchDeleteTokens()" class="btn btn-danger" style="padding: 4px 12px; font-size: 12px;">æ‰¹é‡åˆ é™¤</button>
           </div>`
        : 'æ“ä½œ';

      const tableHTML = `
        <table>
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
              </th>
              <th>æè¿°</th>
              <th>ä»¤ç‰Œ</th>
              <th>çŠ¶æ€</th>
              <th style="text-align: center;">è°ƒç”¨æ¬¡æ•°</th>
              <th style="text-align: center;">æˆåŠŸç‡</th>
              <th style="text-align: center;">æµå¼é¦–å­—å¹³å‡å“åº”</th>
              <th style="text-align: center;">éæµå¼å¹³å‡å“åº”</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æœ€åä½¿ç”¨</th>
              <th>è¿‡æœŸæ—¶é—´</th>
              <th style="width: 200px;">${operationHeader}</th>
            </tr>
          </thead>
          <tbody>
            ${allTokens.map(token => createTokenRow(token)).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = tableHTML;
      updateSelectAllCheckbox();
    }

    function createTokenRow(token) {
      const status = getTokenStatus(token);
      const createdAt = new Date(token.created_at).toLocaleString('zh-CN');
      const lastUsed = token.last_used_at ? new Date(token.last_used_at).toLocaleString('zh-CN') : 'ä»æœªä½¿ç”¨';
      const expiresAt = token.expires_at ? new Date(token.expires_at).toLocaleString('zh-CN') : 'æ°¸ä¸è¿‡æœŸ';
      const isSelected = selectedTokenIds.has(token.id);

      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      const successCount = token.success_count || 0;
      const failureCount = token.failure_count || 0;
      const totalCount = successCount + failureCount;
      const successRate = totalCount > 0 ? ((successCount / totalCount) * 100).toFixed(1) : 0;

      // æˆåŠŸç‡æ ·å¼
      let successRateClass = 'stats-badge';
      if (totalCount > 0) {
        if (successRate >= 95) successRateClass += ' success-rate-high';
        else if (successRate >= 80) successRateClass += ' success-rate-medium';
        else successRateClass += ' success-rate-low';
      }

      // å¹³å‡å“åº”æ—¶é—´
      const streamAvgTTFB = token.stream_avg_ttfb || 0;
      const nonStreamAvgRT = token.non_stream_avg_rt || 0;
      const streamCount = token.stream_count || 0;
      const nonStreamCount = token.non_stream_count || 0;

      // è°ƒç”¨æ¬¡æ•°æ ·å¼ï¼ˆæ ¹æ®è°ƒç”¨é‡ï¼‰
      let countFontWeight = '500';
      let successBgOpacity = '100';
      let errorBgOpacity = '100';
      let successColorOpacity = '700';
      let errorColorOpacity = '700';

      if (totalCount >= 100) {
        countFontWeight = '700';
        successBgOpacity = '200';
        errorBgOpacity = '200';
        successColorOpacity = '800';
        errorColorOpacity = '800';
      } else if (totalCount >= 10) {
        countFontWeight = '600';
        successBgOpacity = '100';
        errorBgOpacity = '100';
        successColorOpacity = '700';
        errorColorOpacity = '700';
      } else {
        countFontWeight = '500';
        successBgOpacity = '50';
        errorBgOpacity = '50';
        successColorOpacity = '600';
        errorColorOpacity = '600';
      }

      // å“åº”æ—¶é—´é¢œè‰²ç­‰çº§
      const getResponseClass = (time) => {
        const num = Number(time);
        if (!Number.isFinite(num) || num <= 0) return '';
        if (num < 3) return 'response-fast';
        if (num < 6) return 'response-medium';
        return 'response-slow';
      };

      return `
        <tr>
          <td>
            <input type="checkbox"
              class="token-checkbox"
              data-token-id="${token.id}"
              onchange="toggleTokenSelection(${token.id}, this.checked)"
              ${isSelected ? 'checked' : ''}
              style="width: 18px; height: 18px; cursor: pointer;">
          </td>
          <td style="font-weight: 500;">${escapeHtml(token.description)}</td>
          <td><span class="token-display">${escapeHtml(token.token)}</span></td>
          <td><span class="status-badge status-${status.class}">${status.text}</span></td>
          <td style="text-align: center;">
            ${totalCount > 0 ? `
              <div style="display: inline-flex; gap: 8px;">
                <span class="stats-badge" style="background: var(--success-${successBgOpacity}); color: var(--success-${successColorOpacity}); font-weight: ${countFontWeight};" title="æˆåŠŸè°ƒç”¨">
                  âœ“ ${successCount.toLocaleString()}
                </span>
                <span class="stats-badge" style="background: var(--error-${errorBgOpacity}); color: var(--error-${errorColorOpacity}); font-weight: ${countFontWeight};" title="å¤±è´¥è°ƒç”¨">
                  âœ— ${failureCount.toLocaleString()}
                </span>
              </div>
            ` : '<span style="color: var(--neutral-500); font-size: 13px;">-</span>'}
          </td>
          <td style="text-align: center;">
            ${totalCount > 0
              ? `<span class="${successRateClass}">${successRate}%</span>`
              : '<span style="color: var(--neutral-500); font-size: 13px;">-</span>'}
          </td>
          <td style="text-align: center;">
            ${streamCount > 0
              ? `<span class="metric-value ${getResponseClass(streamAvgTTFB)}">${streamAvgTTFB.toFixed(2)}s</span>`
              : '<span style="color: var(--neutral-500); font-size: 13px;">-</span>'}
          </td>
          <td style="text-align: center;">
            ${nonStreamCount > 0
              ? `<span class="metric-value ${getResponseClass(nonStreamAvgRT)}">${nonStreamAvgRT.toFixed(2)}s</span>`
              : '<span style="color: var(--neutral-500); font-size: 13px;">-</span>'}
          </td>
          <td style="color: var(--neutral-600);">${createdAt}</td>
          <td style="color: var(--neutral-600);">${lastUsed}</td>
          <td style="color: var(--neutral-600);">${expiresAt}</td>
          <td>
            <button onclick="editToken(${token.id})" class="btn btn-secondary" style="padding: 4px 12px; font-size: 13px; margin-right: 4px;">ç¼–è¾‘</button>
            <button onclick="deleteToken(${token.id})" class="btn btn-danger" style="padding: 4px 12px; font-size: 13px;">åˆ é™¤</button>
          </td>
        </tr>
      `;
    }

    function getTokenStatus(token) {
      if (token.is_expired) return { class: 'expired', text: 'å·²è¿‡æœŸ' };
      if (!token.is_active) return { class: 'inactive', text: 'æœªå¯ç”¨' };
      return { class: 'active', text: 'æ­£å¸¸' };
    }

    function showCreateModal() {
      document.getElementById('tokenDescription').value = '';
      document.getElementById('tokenExpiry').value = 'never';
      document.getElementById('tokenActive').checked = true;
      document.getElementById('customExpiryContainer').style.display = 'none';
      document.getElementById('createModal').style.display = 'block';
    }

    function closeCreateModal() {
      document.getElementById('createModal').style.display = 'none';
    }

    async function createToken() {
      const description = document.getElementById('tokenDescription').value.trim();
      if (!description) {
        showToast('è¯·è¾“å…¥æè¿°', 'error');
        return;
      }
      const expiryType = document.getElementById('tokenExpiry').value;
      let expiresAt = null;
      if (expiryType !== 'never') {
        if (expiryType === 'custom') {
          const customDate = document.getElementById('customExpiry').value;
          if (!customDate) {
            showToast('è¯·é€‰æ‹©è¿‡æœŸæ—¶é—´', 'error');
            return;
          }
          expiresAt = new Date(customDate).getTime();
        } else {
          const days = parseInt(expiryType);
          expiresAt = Date.now() + days * 24 * 60 * 60 * 1000;
        }
      }
      const isActive = document.getElementById('tokenActive').checked;
      try {
        const response = await fetchWithAuth(`${API_BASE}/auth-tokens`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ description, expires_at: expiresAt, is_active: isActive })
        });
        if (!response.ok) throw new Error('åˆ›å»ºå¤±è´¥');
        const data = await response.json();

        closeCreateModal();
        document.getElementById('newTokenValue').value = data.data.token;
        document.getElementById('tokenResultModal').style.display = 'block';
        loadTokens();
        showToast('ä»¤ç‰Œåˆ›å»ºæˆåŠŸ', 'success');
      } catch (error) {
        console.error('åˆ›å»ºä»¤ç‰Œå¤±è´¥:', error);
        showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    function copyToken() {
      const textarea = document.getElementById('newTokenValue');
      textarea.select();
      document.execCommand('copy');
      showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    function closeTokenResultModal() {
      document.getElementById('tokenResultModal').style.display = 'none';
      document.getElementById('newTokenValue').value = '';
    }

    function editToken(id) {
      const token = allTokens.find(t => t.id === id);
      if (!token) return;
      document.getElementById('editTokenId').value = id;
      document.getElementById('editTokenDescription').value = token.description;
      document.getElementById('editTokenActive').checked = token.is_active;
      if (!token.expires_at) {
        document.getElementById('editTokenExpiry').value = 'never';
      } else {
        document.getElementById('editTokenExpiry').value = 'custom';
        document.getElementById('editCustomExpiryContainer').style.display = 'block';
        const date = new Date(token.expires_at);
        document.getElementById('editCustomExpiry').value = date.toISOString().slice(0, 16);
      }
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function updateToken() {
      const id = document.getElementById('editTokenId').value;
      const description = document.getElementById('editTokenDescription').value.trim();
      const isActive = document.getElementById('editTokenActive').checked;
      const expiryType = document.getElementById('editTokenExpiry').value;
      let expiresAt = null;
      if (expiryType !== 'never') {
        if (expiryType === 'custom') {
          const customDate = document.getElementById('editCustomExpiry').value;
          if (!customDate) {
            showToast('è¯·é€‰æ‹©è¿‡æœŸæ—¶é—´', 'error');
            return;
          }
          expiresAt = new Date(customDate).getTime();
        } else {
          const days = parseInt(expiryType);
          expiresAt = Date.now() + days * 24 * 60 * 60 * 1000;
        }
      }
      try {
        const response = await fetchWithAuth(`${API_BASE}/auth-tokens/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ description, is_active: isActive, expires_at: expiresAt })
        });
        if (!response.ok) throw new Error('æ›´æ–°å¤±è´¥');
        closeEditModal();
        loadTokens();
        showToast('æ›´æ–°æˆåŠŸ', 'success');
      } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function deleteToken(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»¤ç‰Œå—?åˆ é™¤åæ— æ³•æ¢å¤ã€‚')) return;
      try {
        const response = await fetchWithAuth(`${API_BASE}/auth-tokens/${id}`, {
          method: 'DELETE'
        });
        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
        selectedTokenIds.delete(id);
        loadTokens();
        showToast('åˆ é™¤æˆåŠŸ', 'success');
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ‰¹é‡æ“ä½œç›¸å…³å‡½æ•°
    function toggleTokenSelection(tokenId, checked) {
      if (checked) {
        selectedTokenIds.add(tokenId);
      } else {
        selectedTokenIds.delete(tokenId);
      }
      renderTokens(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è¡¨å¤´
    }

    function toggleSelectAll(checked) {
      if (checked) {
        allTokens.forEach(token => selectedTokenIds.add(token.id));
      } else {
        selectedTokenIds.clear();
      }
      renderTokens();
    }

    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('select-all');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allTokens.length > 0 && selectedTokenIds.size === allTokens.length;
        selectAllCheckbox.indeterminate = selectedTokenIds.size > 0 && selectedTokenIds.size < allTokens.length;
      }
    }



    async function batchDeleteTokens() {
      if (selectedTokenIds.size === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»¤ç‰Œ', 'error');
        return;
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTokenIds.size} ä¸ªä»¤ç‰Œå—?åˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
        return;
      }

      const idsToDelete = Array.from(selectedTokenIds);
      let successCount = 0;
      let failCount = 0;

      for (const id of idsToDelete) {
        try {
          const response = await fetchWithAuth(`${API_BASE}/auth-tokens/${id}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            successCount++;
            selectedTokenIds.delete(id);
          } else {
            failCount++;
          }
        } catch (error) {
          console.error(`åˆ é™¤ä»¤ç‰Œ ${id} å¤±è´¥:`, error);
          failCount++;
        }
      }

      loadTokens();

      if (failCount === 0) {
        showToast(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªä»¤ç‰Œ`, 'success');
      } else {
        showToast(`åˆ é™¤å®Œæˆ: æˆåŠŸ ${successCount} ä¸ª, å¤±è´¥ ${failCount} ä¸ª`, 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 12px 20px;
        background: ${type === 'success' ? 'var(--success-500)' : type === 'error' ? 'var(--error-500)' : 'var(--primary-500)'};
        color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000; animation: slideIn 0.3s ease-out;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <script>
    // åˆå§‹åŒ–é¡¶éƒ¨å¯¼èˆªæ 
    document.addEventListener('DOMContentLoaded', () => {
      initTopbar('tokens');
    });
  </script>
</body>
</html>
