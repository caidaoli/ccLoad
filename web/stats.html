<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/web/favicon.ico">
  <link rel="apple-touch-icon" href="/web/apple-touch-icon.png">
  <link rel="manifest" href="/web/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <title>调用统计 - Claude Code & Codex Proxy</title>
  <link rel="stylesheet" href="/web/assets/css/styles.css">
  <link href="/web/assets/css/inter.css" rel="stylesheet">
  <link rel="stylesheet" href="/web/assets/css/channels.css">
</head>
<body>
  <div class="app-container">
    

    <!-- 主内容区域 -->
    <main class="main-content">
      <div class="content-area">
        <!-- 页面标题 -->
        <header class="mb-2">
        </header>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="filter-controls">
            <!-- 渠道类型筛选 -->
            <div class="filter-group">
              <label for="f_channel_type" class="filter-label">渠道类型</label>
              <select id="f_channel_type" class="filter-select" style="min-width: 120px;">
                <!-- 动态加载渠道类型选项 -->
              </select>
            </div>

            <!-- 时间范围筛选 -->
            <div class="filter-group">
              <label for="f_hours" class="filter-label">时间范围</label>
              <select id="f_hours" class="filter-select" style="min-width: 100px;">
                <!-- 动态生成选项 by date-range-selector.js -->
              </select>
            </div>

            <!-- 渠道ID筛选 -->
            <div class="filter-group">
              <label for="f_id" class="filter-label">渠道ID</label>
              <input type="number" id="f_id" class="filter-input" placeholder="输入ID..." style="max-width: 100px;">
            </div>

            <!-- 渠道名筛选 -->
            <div class="filter-group">
              <label for="f_name" class="filter-label">渠道名</label>
              <input type="text" id="f_name" class="filter-input" placeholder="包含文本...">
            </div>

            <!-- 模型筛选（合并重复字段） -->
            <div class="filter-group">
              <label for="f_model" class="filter-label">模型</label>
              <input type="text" id="f_model" class="filter-input" placeholder="包含文本...">
            </div>

            <!-- 令牌筛选 -->
            <div class="filter-group">
              <label for="f_auth_token" class="filter-label">令牌</label>
              <select id="f_auth_token" class="filter-select" style="min-width: 150px;">
                <option value="">全部令牌</option>
                <!-- 动态加载令牌列表 -->
              </select>
            </div>

            <!-- 统计信息 -->
            <div class="filter-info">
              共 <span id="statsCount">0</span> 条记录
            </div>

            <!-- 操作按钮组 -->
            <div style="flex: none;">
              <button id="btn_filter" type="button" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">筛选</button>
            </div>
          </div>
        </div>

        <!-- 统计详情表格 -->
        <section class="mb-8">
          <div class="glass-card animate-slide-up" style="animation-delay: 0.3s;">
            <h3 class="section-title mb-6">
              <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              详细统计数据
              <small style="color: var(--neutral-600); font-weight: var(--font-normal); margin-left: var(--space-2);">
                按渠道名称、模型名称排序
              </small>
            </h3>
            
            <!-- 统计表格 -->
            <div class="table-container">
              <table class="modern-table stats-table">
                <thead>
                  <tr>
                    <th class="sortable" data-column="channel_name" onclick="sortTable('channel_name')">
                      渠道名称
                      <span class="sort-indicator" id="sort-channel_name"></span>
                    </th>
                    <th class="sortable" data-column="model" onclick="sortTable('model')">
                      模型
                      <span class="sort-indicator" id="sort-model"></span>
                    </th>
                    <th class="sortable" data-column="success" onclick="sortTable('success')" style="color: var(--success-400);">
                      成功次数
                      <span class="sort-indicator" id="sort-success"></span>
                    </th>
                    <th class="sortable" data-column="error" onclick="sortTable('error')" style="color: var(--error-400);">
                      失败次数
                      <span class="sort-indicator" id="sort-error"></span>
                    </th>
                    <th class="sortable" data-column="success_rate" onclick="sortTable('success_rate')">
                      成功率
                      <span class="sort-indicator" id="sort-success_rate"></span>
                    </th>
                    <th class="sortable" data-column="avg_first_byte_time" onclick="sortTable('avg_first_byte_time')">
                      平均首字/耗时(秒)
                      <span class="sort-indicator" id="sort-avg_first_byte_time"></span>
                    </th>
                    <th class="sortable" data-column="total_input_tokens" onclick="sortTable('total_input_tokens')">
                      输入Token
                      <span class="sort-indicator" id="sort-total_input_tokens"></span>
                    </th>
                    <th class="sortable" data-column="total_output_tokens" onclick="sortTable('total_output_tokens')">
                      输出Token
                      <span class="sort-indicator" id="sort-total_output_tokens"></span>
                    </th>
                    <th class="sortable" data-column="total_cache_read" onclick="sortTable('total_cache_read')" style="color: var(--success-600);">
                      缓存读取
                      <span class="sort-indicator" id="sort-total_cache_read"></span>
                    </th>
                    <th class="sortable" data-column="total_cache_creation" onclick="sortTable('total_cache_creation')" style="color: var(--primary-600);">
                      缓存创建
                      <span class="sort-indicator" id="sort-total_cache_creation"></span>
                    </th>
                    <th class="sortable" data-column="total_cost" onclick="sortTable('total_cost')" style="color: var(--warning-600);">
                      成本($)
                      <span class="sort-indicator" id="sort-total_cost"></span>
                    </th>
                  </tr>
                </thead>
                <tbody id="stats_tbody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- 加载状态模板 -->
  <template id="tpl-stats-loading">
    <tr>
      <td colspan="{{colspan}}" class="loading-state">
        <div class="loading-spinner" style="margin: 0 auto var(--space-2)"></div>
        正在加载统计数据...
      </td>
    </tr>
  </template>

  <!-- 错误状态模板 -->
  <template id="tpl-stats-error">
    <tr>
      <td colspan="{{colspan}}" class="empty-state">
        <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--error-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.18 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <div style="color: var(--error-400); font-weight: var(--font-medium); margin-bottom: var(--space-1);">加载失败</div>
        <div>请检查网络连接或重试</div>
      </td>
    </tr>
  </template>

  <!-- 空数据状态模板 -->
  <template id="tpl-stats-empty">
    <tr>
      <td colspan="{{colspan}}" class="empty-state">
        <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--neutral-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <div style="font-weight: var(--font-medium); margin-bottom: var(--space-1); color: var(--neutral-700);">暂无统计数据</div>
        <div>请调整筛选条件或检查时间范围</div>
      </td>
    </tr>
  </template>

  <!-- 数据行模板 -->
  <template id="tpl-stats-row">
    <tr>
      <td>
        <a href="/web/channels.html?id={{channelId}}#channel-{{channelId}}" class="config-name channel-link" title="跳转到渠道管理">{{channelName}}</a>
        {{{channelIdBadge}}}
      </td>
      <td>{{{modelDisplay}}}</td>
      <td><span class="success-count">{{successCount}}</span></td>
      <td><span class="error-count">{{errorCount}}</span></td>
      <td>
        <div class="{{successRateClass}}">{{successRateText}}</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{successRate}}%"></div>
        </div>
      </td>
      <td style="text-align: center;">{{{avgFirstByteTime}}}</td>
      <td style="text-align: right;">{{{inputTokens}}}</td>
      <td style="text-align: right;">{{{outputTokens}}}</td>
      <td style="text-align: right;">{{{cacheReadTokens}}}</td>
      <td style="text-align: right;">{{{cacheCreationTokens}}}</td>
      <td style="text-align: right;">{{{costText}}}</td>
    </tr>
  </template>

  <!-- 合计行模板 -->
  <template id="tpl-stats-total">
    <tr style="background-color: var(--primary-50); font-weight: bold; border-top: 2px solid var(--primary-200);">
      <td colspan="2" style="text-align: center; font-size: 15px; color: var(--primary-700);">合计</td>
      <td><span class="success-count">{{successCount}}</span></td>
      <td><span class="error-count">{{errorCount}}</span></td>
      <td style="text-align: center; font-size: 14px;">{{successRateText}}</td>
      <td style="text-align: center;"></td>
      <td style="text-align: right;">{{inputTokens}}</td>
      <td style="text-align: right;">{{outputTokens}}</td>
      <td style="text-align: right;"><span style="color: var(--success-600);">{{cacheReadTokens}}</span></td>
      <td style="text-align: right;"><span style="color: var(--primary-600);">{{cacheCreationTokens}}</span></td>
      <td style="text-align: right;"><span style="color: var(--warning-600); font-weight: 600;">{{costText}}</span></td>
    </tr>
  </template>

  <script src="/web/assets/js/template-engine.js"></script>
  <script src="/web/assets/js/date-range-selector.js"></script>
  <script src="/web/assets/js/stats.js"></script>
  <script src="/web/assets/js/ui.js"></script>
</body>
</html>
