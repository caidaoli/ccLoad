<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>请求日志 - Claude Code & Codex Proxy</title>
  <link rel="stylesheet" href="/web/styles.css">
  <link rel="preconnect" href="https://fonts.loli.net">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.loli.net/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    

    <!-- 主内容区域 -->
    <main class="main-content">
      <div class="content-area">
     <!-- 页面标题 -->
        <header class="mb-2">
        </header>

        <!-- 筛选区域 -->
        <section class="mb-4">
          <div class="glass-card animate-slide-up" style="animation-delay: 0.1s;">
            <h3 class="text-xl font-semibold mb-6">
              <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
              </svg>
              日志筛选条件
            </h3>
            <div class="filter-container" style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap;">
              <div class="form-group" style="flex: 0 0 auto; min-width: 120px;">
                <label for="f_hours" class="form-label">最近小时</label>
                <input id="f_hours" type="number" min="1" max="168" class="form-input" value="24" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex: 0 0 auto; min-width: 120px;">
                <label for="f_id" class="form-label">渠道ID</label>
                <input id="f_id" type="number" class="form-input" placeholder="精确ID" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex: 1 1 auto; min-width: 140px;">
                <label for="f_name" class="form-label">渠道名包含</label>
                <input id="f_name" type="text" class="form-input" placeholder="关键字" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex: 1 1 auto; min-width: 140px;">
                <label for="f_model" class="form-label">模型包含</label>
                <input id="f_model" type="text" class="form-input" placeholder="关键字" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex: 1 1 auto; min-width: 140px;">
                <label for="f_model_like" class="form-label">模型包含</label>
                <input id="f_model_like" type="text" class="form-input" placeholder="关键字" style="width: 100%;" />
              </div>
              <div class="form-group" style="flex: 0 0 auto; min-width: 100px; display: flex; align-items: end;">
                <button id="btn_filter" class="btn btn-primary" style="width: 100%;">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                  </svg>
                  筛选
                </button>
              </div>
            </div>
          </div>
        </section>

  
        <!-- 日志列表 -->
        <section class="mb-8">
          <div class="glass-card animate-slide-up" style="animation-delay: 0.2s;">
           
            
            <!-- 日志表格 -->
            <div class="table-container">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>时间</th>
                    <th>模型</th>
                    <th>渠道</th>
                    <th>API Key</th>
                    <th>状态码</th>
                    <th>类型</th>
                    <th>耗时(秒)</th>
                    <th>首字节(秒)</th>
                    <th>信息</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 底部分页控制 -->
        <section class="mb-8">
          <div class="glass-card" style="padding: var(--space-4);">
            <div class="flex justify-center items-center">
              <div class="pagination-controls">
                <button id="logs_prev2" class="btn btn-secondary btn-sm" onclick="prevLogsPage()">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                  上一页
                </button>
                <span class="pagination-info" style="margin: 0 var(--space-4);">
                  第 <span id="logs_current_page2">1</span> 页，共 <span id="logs_total_pages2">1</span> 页
                </span>
                <button id="logs_next2" class="btn btn-secondary btn-sm" onclick="nextLogsPage()">
                  下一页
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  


  <script>
    let currentLogsPage = 1;
    let logsPageSize = 20;
    let totalLogsPages = 1;
    let totalLogs = 0;

    async function load() {
      try {
        showLoading();
        
        const u = new URLSearchParams(location.search);
        const params = new URLSearchParams({
          hours: (u.get('hours')||'24'), 
          limit: logsPageSize.toString(),
          offset: ((currentLogsPage - 1) * logsPageSize).toString()
        });
        
        if (u.get('channel_id')) params.set('channel_id', u.get('channel_id'));
        if (u.get('channel_name')) params.set('channel_name', u.get('channel_name'));
        if (u.get('channel_name_like')) params.set('channel_name_like', u.get('channel_name_like'));
        if (u.get('model')) params.set('model', u.get('model'));
        if (u.get('model_like')) params.set('model_like', u.get('model_like'));
        
        const res = await fetch('/admin/errors?' + params.toString());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const response = await res.json();
        const data = response.success ? (response.data || []) : (response || []);
        
        // 计算总页数
        if (data.length === logsPageSize) {
          totalLogsPages = Math.max(currentLogsPage + 1, totalLogsPages);
        } else if (data.length < logsPageSize && currentLogsPage === 1) {
          totalLogsPages = 1;
        } else if (data.length < logsPageSize) {
          totalLogsPages = currentLogsPage;
        }
        
        updatePagination();
        renderLogs(data);
        
      } catch (error) {
        console.error('加载日志失败:', error);
        try { if (window.showError) window.showError('无法加载请求日志'); } catch(_){}
        showError();
      }
    }

    function showLoading() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="loading-state">
            <div class="loading-spinner" style="margin: 0 auto var(--space-2)"></div>
            正在加载日志...
          </td>
        </tr>
      `;
    }

    function showError() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="empty-state">
            <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--error-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.864-.833-2.634 0L4.18 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
            <div style="color: var(--error-400); font-weight: var(--font-medium); margin-bottom: var(--space-1);">加载失败</div>
            <div>请检查网络连接或重试</div>
          </td>
        </tr>
      `;
    }

    function renderLogs(data) {
      const tbody = document.getElementById('tbody');

      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="empty-state">
              <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--neutral-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <div style="font-weight: var(--font-medium); margin-bottom: var(--space-1); color: var(--neutral-700);">暂无日志数据</div>
              <div>请调整筛选条件或检查时间范围</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = '';
      for (const entry of data) {
        const tr = document.createElement('tr');
        
        const configInfo = entry.channel_name || 
          (entry.channel_id ? `渠道 #${entry.channel_id}` : 
           (entry.message === 'exhausted backends' ? '系统（所有渠道失败）' : 
            entry.message === 'no available upstream (all cooled or none)' ? '系统（无可用渠道）' : '系统'));
        const configDisplay = entry.channel_id ? 
          `<a class="channel-link" href="/web/channels.html#channel-${entry.channel_id}">${escapeHtml(entry.channel_name||'')} <small>(#${entry.channel_id})</small></a>` : 
          `<span style="color: var(--neutral-500);">${escapeHtml(configInfo)}</span>`;
        
        const statusClass = (entry.status_code >= 200 && entry.status_code < 300) ? 
          'status-success' : 'status-error';
          
        const modelDisplay = entry.model ? 
          `<span class="model-tag">${escapeHtml(entry.model)}</span>` : 
          '<span style="color: var(--neutral-500);">-</span>';
        
        // 请求类型显示
        const typeDisplay = entry.is_streaming ? 
          '<span class="stream-tag">流式</span>' : 
          '<span class="batch-tag"></span>';
        
        // 格式化耗时显示
        const durationDisplay = entry.duration !== undefined && entry.duration !== null ? 
          `<span style="color: var(--neutral-700);">${entry.duration.toFixed(3)}</span>` : 
          '<span style="color: var(--neutral-500);">-</span>';
          
        // 格式化首字节时间显示（仅流式请求）
        const firstByteDisplay = entry.is_streaming && entry.first_byte_time !== undefined && entry.first_byte_time !== null ?
          `<span style="color: var(--success-600);">${entry.first_byte_time.toFixed(3)}</span>` :
          '<span style="color: var(--neutral-500);">-</span>';

        // 格式化API Key显示（已在后端掩码处理）
        const apiKeyDisplay = entry.api_key_used ?
          `<code style="font-size: 0.9em; color: var(--neutral-600);">${escapeHtml(entry.api_key_used)}</code>` :
          '<span style="color: var(--neutral-500);">-</span>';

        tr.innerHTML = `
          <td style="white-space: nowrap;">${formatTime(entry.time)}</td>
          <td>${modelDisplay}</td>
          <td class="config-info">${configDisplay}</td>
          <td style="text-align: center; white-space: nowrap;">${apiKeyDisplay}</td>
          <td><span class="${statusClass}">${entry.status_code}</span></td>
          <td style="text-align: center;">${typeDisplay}</td>
          <td style="text-align: right; white-space: nowrap;">${durationDisplay}</td>
          <td style="text-align: right; white-space: nowrap;">${firstByteDisplay}</td>
          <td style="max-width: 300px; word-break: break-word;">${escapeHtml(entry.message || '')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function updatePagination() {
      // 更新页码显示（只更新底部分页）
      const currentPage2El = document.getElementById('logs_current_page2');
      const totalPages2El = document.getElementById('logs_total_pages2');
      const prev2El = document.getElementById('logs_prev2');
      const next2El = document.getElementById('logs_next2');
      
      if (currentPage2El) currentPage2El.textContent = currentLogsPage;
      if (totalPages2El) totalPages2El.textContent = totalLogsPages;
      
      // 更新按钮状态（只更新底部分页）
      const prevDisabled = currentLogsPage <= 1;
      const nextDisabled = currentLogsPage >= totalLogsPages;
      
      if (prev2El) prev2El.disabled = prevDisabled;
      if (next2El) next2El.disabled = nextDisabled;
    }

    function prevLogsPage() {
      if (currentLogsPage > 1) {
        currentLogsPage--;
        load();
      }
    }

    function nextLogsPage() {
      if (currentLogsPage < totalLogsPages) {
        currentLogsPage++;
        load();
      }
    }

    function changePageSize() {
      const newPageSize = parseInt(document.getElementById('page_size').value);
      if (newPageSize !== logsPageSize) {
        logsPageSize = newPageSize;
        currentLogsPage = 1;
        totalLogsPages = 1;
        load();
      }
    }

    function applyFilter() {
      currentLogsPage = 1;
      totalLogsPages = 1;
      
      const hours = document.getElementById('f_hours').value.trim();
      const id = document.getElementById('f_id').value.trim();
      const name = document.getElementById('f_name').value.trim();
      const model = document.getElementById('f_model').value.trim();
      const modelLike = document.getElementById('f_model_like').value.trim();
      const q = new URLSearchParams(location.search);
      
      if (hours) q.set('hours', hours); else q.delete('hours');
      if (id) q.set('channel_id', id); else q.delete('channel_id');
      if (name) { q.set('channel_name_like', name); q.delete('channel_name'); }
      else { q.delete('channel_name_like'); }
      if (model) { q.set('model_like', model); q.delete('model'); }
      else { if (modelLike) q.set('model_like', modelLike); else q.delete('model_like'); q.delete('model'); }
      
      location.search = '?' + q.toString();
    }

    function initFilters() {
      const u = new URLSearchParams(location.search);
      const id = u.get('channel_id') || '';
      const name = u.get('channel_name_like') || u.get('channel_name') || '';
      const hours = u.get('hours') || '24';
      const model = u.get('model') || '';
      const modelLike = u.get('model_like') || '';
      
      document.getElementById('f_hours').value = hours;
      document.getElementById('f_id').value = id;
      document.getElementById('f_name').value = name;
      document.getElementById('f_model').value = model;
      document.getElementById('f_model_like').value = modelLike;
      
      // 事件监听
      document.getElementById('btn_filter').addEventListener('click', applyFilter);
      
      // 回车键筛选
      ['f_hours', 'f_id', 'f_name', 'f_model', 'f_model_like'].forEach(id => {
        document.getElementById(id).addEventListener('keydown', e => {
          if (e.key === 'Enter') applyFilter();
        });
      });
    }

    function formatTime(timeStr) {
      try {
        const date = new Date(timeStr);
        if (isNaN(date.getTime()) || date.getFullYear() < 2020) {
          return '-';
        }
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return '-';
      }
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }


    // 注销功能
    function logout() {
      if (confirm('确定要注销吗？')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/web/login.html';
          })
          .catch(() => {
            window.location.href = '/web/login.html';
          });
      }
    }

    // 顶栏布局下，无需侧栏响应逻辑
    function handleResize() {}

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.initTopbar) initTopbar('logs');
      initFilters();
      load();
      
      // 响应式处理
      handleResize();
      window.addEventListener('resize', handleResize);
    });
  </script>
  <script src="/web/ui.js"></script>
</body>
</html>
